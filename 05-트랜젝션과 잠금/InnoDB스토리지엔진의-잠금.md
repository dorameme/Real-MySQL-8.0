
## 5.3 InnoDB 스토리지 엔진의 잠금

레코드 기반의 잠금방식으로 레거시인 MyISAM보다 훨씬 뛰어난 동시성처리를 제공할 수 있다.


## 5.3.1.1 레코드 락(Record Lock)

### 1. 개념

* 특정 **행(row) 하나에 거는 락**
* 트랜잭션이 해당 행을 수정하거나 참조할 때 자동으로 걸린다.

### 2. 특징

* 독점적 배타락(X) 또는 공유락(S) 가능
* 다른 행에는 영향 없음 → 높은 동시성 보장
* InnoDB 기본 락

### 3. 실무 쓰임

* UPDATE, DELETE 시 자동 적용
* 특정 레코드 충돌 방지 → 은행 계좌 출금, 주문 처리 등

```sql
SELECT * FROM orders WHERE id=100 FOR UPDATE;  -- 레코드 락
```

---

## 5.3.1.2 갭 락(Gap Lock)

### 1. 개념

* **행 사이의 “공백(gap)”에 거는 락**
* 존재하지 않는 레코드 삽입을 막아 **팬텀 문제(Phantom Problem)** 방지

### 2. 특징

* 실제 행이 아니라 **범위 잠금**
* REPEATABLE READ 격리 수준에서 주로 발생

### 3. 실무 쓰임

* 동시 트랜잭션에서 **범위 내 새로운 레코드 삽입 방지**
* 예: 주문번호 중복 방지, 범위 조건 충돌 방지

```sql
SELECT * FROM orders WHERE id BETWEEN 100 AND 200 FOR UPDATE;  -- 갭 락 발생
```

---

## 5.3.1.3  넥스트-키 락(Next-Key Lock)

### 1. 개념

* **레코드 락 + 갭 락 결합**
* 즉, 특정 행과 그 이전 갭을 동시에 잠그는 방식

### 2. 특징

* 팬텀 문제 방지 목적
* InnoDB REPEATABLE READ 격리 수준에서 기본 락 전략

### 3. 실무 쓰임

* 범위 조건 조회 후 삽입/삭제 충돌 방지
* 예:

```sql
SELECT * FROM orders WHERE id >= 100 AND id <= 200 FOR UPDATE;  -- 넥스트-키 락
```

---

## 5.3.1.4 자동 증가 락(Auto-increment Lock)

### 1. 개념

* **AUTO\_INCREMENT 컬럼에 새로운 값 생성 시 걸리는 락**
* MySQL이 동시에 AUTO\_INCREMENT 값을 생성할 때 충돌 방지

### 2. 특징

* 레코드 단위가 아니라 **테이블 단위**로 잠금 발생
* InnoDB에서는 **Interleaved 모드(innodb\_autoinc\_lock\_mode)에 따라 다르게 동작**

  * 0: “traditional” – 단일 락, 직렬화
  * 1: “consecutive” – 병렬성 허용
  * 2: “interleaved” – 최적화된 병렬 처리

### 3. 실무 쓰임

* 다중 세션에서 동시에 AUTO\_INCREMENT 컬럼 INSERT 시 충돌 방지
* 예: 주문번호, 회원번호, 트랜잭션 ID 생성

```sql
INSERT INTO orders (user_id) VALUES (101);  -- 자동 증가 락 관리
```

---

### 요약 비교표

| 락 종류        | 잠금 대상              | 특징                       | 실무 쓰임                            |
| ----------- | ------------------ | ------------------------ | -------------------------------- |
| **레코드 락**   | 특정 행(row)          | 행 단위, 공유/배타 가능           | UPDATE/DELETE 충돌 방지, 계좌/주문 처리    |
| **갭 락**     | 행 사이 공백            | 범위 잠금, 존재하지 않는 레코드 삽입 방지 | 범위 내 INSERT/중복 방지, 팬텀 방지         |
| **넥스트-키 락** | 행 + 이전 갭           | 레코드 락 + 갭 락 결합, 팬텀 방지    | REPEATABLE READ 기본, 범위 조건 동시성 보호 |
| **자동 증가 락** | AUTO\_INCREMENT 컬럼 | 테이블 단위, 동시에 값 생성 충돌 방지   | 주문번호, 회원번호, 트랜잭션 ID 생성           |

---
모든 락이 기본적으로 MySQL/InnoDB에 의해 자동 관리됨
개발자가 직접 락을 명시할 필요는 거의 없음

단, 락 때문에 DDL 지연, INSERT 대기, 범위 충돌 등 현상은 인지하고 있어야 함
